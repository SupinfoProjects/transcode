version: '2'
services:
  # meteor_1:
  #   image: ubuntu
  #   ports:
  #     - "80:80"
  #   links:
  #     - mongo_1
  #     - mongo_2
  #     - mongo_3
  #     - mongo_setup
  # meteor_2:
  #   image: ubuntu
  #   expose:
  #     - "80"
  #   links:
  #     - mongo_1
  #     - mongo_2
  #     - mongo_3
  #     - mongo_setup
  #     - meteor_1
  # meteor_setup:
  #   image: ubuntu
  # mongo_1:
  #   image: mongo
  #   command: --smallfiles --replSet transcode --quiet
  # mongo_2:
  #   image: mongo
  #   command: --smallfiles --replSet transcode --quiet
  # mongo_3:
  #   image: mongo
  #   command: --smallfiles --replSet transcode --quiet
  # mongo_setup:
  #   image: wdhif/mongo-replicaset-setup
  #   links:
  #     - mongo_1
  #     - mongo_2
  #     - mongo_3
  #   environment:
  #     DATABASE: transcode
  #     REPLICA_SET_ID: transcode
  #     PRIMARY_MEMBER: mongo_1:27017
  #     SECONDARY_MEMBERS: mongo_2:27017,mongo_3:27017
  data:
    image: ubuntu
    command: sleep infinity
    volumes:
      - /var/lib/data
  core:
    image: celery
    environment:
      - C_FORCE_ROOT=true
      - BROKER_URL=amqp://guest:guest@broker//
      - CELERY_BROKER_URL=amqp://guest:guest@broker//
    links:
      - broker
    volumes_from:
      - data
    volumes:
      - ./scripts:/home/user
    command: bash -c "celery -A core worker -l info --app=core.core.app"
    expose:
      - "5555"
  broker:
    image: rabbitmq
    expose:
      - "5672"
  worker:
    image: celery
    environment:
      - C_FORCE_ROOT=true
      - BROKER_URL=amqp://guest:guest@broker//
      - CELERY_BROKER_URL=amqp://guest:guest@broker//
    links:
      - core
      - broker
    volumes_from:
      - data
    volumes:
      - ./scripts:/home/user
    command: bash -c "celery -A worker worker -l info --app=worker.worker.app"
    expose:
      - "5555"
